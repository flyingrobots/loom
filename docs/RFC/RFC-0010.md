---
Status: Draft**
Author: James Ross
Contributors: JIT Community
Requires:
- RFC-0001
- RFC-0002
- RFC-0003
- RFC-0005
- RFC-0006
Start Date: 2025-11-28
Target Spec: JITOS v0.x
License: TBD
---

# JIT RFC-0010

## Ref Management & Branch Semantics (RBS v1.0)

### The Truth Pointers of the Inversion Kernel


---

## 1. Summary

This RFC defines:

- the ontology of references (“refs”)
- how branches behave
- how tags are represented
- how HEAD operates
- how reference mutation occurs
- how SWS and commits update refs
- how distributed sync applies ref updates
- the invariants refs MUST obey

Refs are the names humans give to points in the causal DAG.
Branches are pointers to worldline frontiers.
Tags are semantic anchors.
HEAD is a lens, not a truth.
This RFC defines how pointers to the universe behave.

---

## 2. Motivation

Without refs you have:

- an infinite DAG
- no landmarks
- no naming
- no identification
- no “current state”
- no way to express intent

Refs provide the symbolic layer that makes:

- collaboration
- navigation
- tooling
- UX
- agents
- CI
- 
possible.

But refs MUST NOT mutate truth.
Refs must point into truth.

Thus:

***Refs are illusions, DAG is reality.***

This RFC defines how those illusions function.

---

## 3. Definitions

### 3.1 Reference (Ref)

A ref is:

```rust
Ref {
    name: string
    target: NodeID
    metadata: map<string,string>
}
```

Refs MUST be stored in LMDB and versioned through WAL.

Refs MUST be human-readable, but truth is the NodeID.

---

### 3.2 Branch

A branch is a ref representing a living timeline.

Typical examples:

- `main`
- `dev`
- `feature/x`
- `experiment/y`

Requirements:

- branch ref MUST always point to a snapshot node
- commits update branch target
- branch semantics MUST be deterministic

---

## 3.3 Tag

A **tag** is a ref that MUST NOT move.

Used for:

- releases
- checkpoints
- semantic anchors
- temporal anchors
- analysis states

Tags MUST reference:

- snapshot nodes
- rewrite nodes
- provenance nodes

Tags are immutable pointers to events in the universe.

---

## 3.4 HEAD

HEAD is:

- a human-facing pointer
- ephemeral
- local-only
- specific to Materialized Head
- MUST NOT appear in the DAG

HEAD indicates current projection, not objective truth.

---

## 4. Reference Invariants

These MUST hold at all times:

### Invariant 1 — Ref target MUST exist in DAG

No ref may point to non-existent nodes.

### Invariant 2 — Branch updates MUST be atomic

Ref update MUST be written LAST during commit.

### Invariant 3 — Branch ref changes MUST be WAL-logged

Ensures replay consistency.

### Invariant 4 — Tag ref MUST NOT change

Immutable forever.

### Invariant 5 — No ref may violate causal ordering

A branch MUST NOT point “backwards” in violation of DAG invariants.

### Invariant 6 — HEAD is not truth

HEAD may be detached or point to MH state.

### Invariant 7 — Fast-forward rules MUST be deterministic

Conflicting branch updates MUST involve inversion engine.

---

## 5. Operations

### 5.1 ref.get

```rust
op: "ref.get"
payload: { name }
result: { target: NodeID }
```

---

### 5.2 ref.set (Branch only)

```rust
op: "ref.set"
payload: { name, new_target }
result: { updated: bool }
```

Rules:

- MUST be atomic
- MUST appear after snapshot+rewrite nodes in WAL
- MUST update MH
- MUST invalidate outdated SWS

---

### 5.3 ref.create_branch

```rust
op: "ref.create_branch"
payload: { name, target }
```

Branch MUST begin at an existing node.

---

### 5.4 ref.create_tag

```rust
op: "ref.create_tag"
payload: { name, target }
```

Tag MUST be immutable.

---

### 5.5 ref.delete

Allowed only for branches.

Tags MUST NOT be deleted except by explicit override.

---

## 6. Branch Update Semantics

Commits MUST update branch target as:

```rust
branch -> new_snapshot_node
```

Merge semantics MUST be:

- deterministic
- mediated by Inversion Engine
- logged via WAL
- projection applied to MH

---

## 7. Rebase Semantics

Rebase MUST NOT mutate branch history.

Instead:

- inversion-rewrite node created
- branch updated to rewritten snapshot
- original lineage preserved

Branch “moves” but truth remains immutable.

---

## 8. Distributed Sync

Ref sync MUST obey:

- last-writer-wins
- mediated by inversion
- no destructive pushes
- rewrite required for divergence

Distributed push/pull MUST:

- verify node existence
- validate rewrite rules
- enforce invariant ordering

Remote branch updates MUST be replayed deterministically.

---

## 9. HEAD Semantics

HEAD is:

- local
- advisory
- non-authoritative
- ephemeral
- tied to Materialized Head

HEAD MUST NOT appear in DAG or WAL.

HEAD MAY:

- point to SWS
- point to snapshot
- be detached
- be symbolic

HEAD is simply a lens.

---

## 10. Security

Reference operations MUST:

- validate user permissions
- require signatures (future)
- reject invalid pointers
- disallow backward ref changes
- log all updates via WAL

---

## 11. Why Ref Semantics Matter

Refs are:

- the human interface
- the names of time
- the symbols for worldlines
- the navigational layer
- the external interface for distributed tooling
- the bridge between the cave wall and the causal universe

Refs don’t define truth.
Refs point to truth.

This RFC formalizes naming in a world without filenames.

---

## 12. Status & Next Steps

### Next RFC to write:

[RFC-0011](./RFC-0011.md) — Distributed Sync: Frontier Negotiation & Subgraph Transfer

---

# **CΩMPUTER • JITOS** 
© 2025 James Ross • [Flying • Robots](https://flyingrobots.dev)
All Rights Reserved

